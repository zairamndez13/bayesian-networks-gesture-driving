---
title: "Análisis de datos"
author: "Zaïra Méndez"
date: "2025-06-10"
output: html_document
---

```{r}
#Librerías
library(dplyr)
library(ggplot2)
library(ggcorrplot)
```


# Preparación de datos
```{r}
#Cargamos los datos
load("C:/.../escalas_EMOCIONESN_new.RData")
load("C:/.../AU_EMOCIONESN_new.RData")
Datos_usuarios <- read.csv("Datos_usuarios.csv", sep = ";", stringsAsFactors = FALSE)


#Formato y limpieza de datos
AUs_EMOCIONESNn <- subset(AU_EMOCIONESN[,c(1,2,3,4,8,9,10,11,13,16,22)] )

AUs_EMOCIONESN <- subset(AUs_EMOCIONESNn, Phase %in% c("Baseline 2", "Rage")) #fase basal y de rabia

AUs_EMOCIONESN <- AUs_EMOCIONESN %>%
  group_by(User, Phase) %>%
  summarise(
    across(c(AU02_Mean, AU04_Mean, AU05_Mean, AU06_Mean, AU09_Mean, AU12_Mean, AU24_Mean), 
          \(x) mean(x, na.rm = TRUE)),
    .groups = "drop"
  )

escalas_EMOCIONRAGE <- subset(escalas_EMOCIONESN[,c(1,3,12)], Phase %in% c("Baseline 2", "Rage"))

datosnew <- left_join(AUs_EMOCIONESN, escalas_EMOCIONRAGE, by = c("User" = "User", "Phase"="Phase"))

#como queremos trabajar con variable Beta, dividimos el dato por 100
datosnew$Rage <- datosnew$Rage/100

# Seleccionar solo las columnas User y Sexo
datos_filtrados <- Datos_usuarios %>% 
  select(User, Sex)

datos_filtrados$Sex <- as.factor(datos_filtrados$Sex)

# Unir con la base de datos ya combinada datosnew
datosnew <- left_join(datosnew, datos_filtrados, by = "User")

datosnew$User <- rep(1:34,1,NA,2) #individuos seguidos

# Renombrar variables en el dataframe datosnew
names(datosnew)[names(datosnew) == "AU02_Mean"] <- "$Y_K$"
names(datosnew)[names(datosnew) == "AU04_Mean"] <- "Y_C"
names(datosnew)[names(datosnew) == "AU05_Mean"] <- "Y_P"
names(datosnew)[names(datosnew) == "AU06_Mean"] <- "Y_M"
names(datosnew)[names(datosnew) == "AU09_Mean"] <- "Y_N"
names(datosnew)[names(datosnew) == "AU12_Mean"] <- "Y_S"
names(datosnew)[names(datosnew) == "AU24_Mean"] <- "Y_L"

# Renombrar variable furia
names(datosnew)[names(datosnew) == "Rage"] <- "Y_F"
```


# Selección de gestos relevantes
```{r}
matcor1<-cor(datosnew[,3:10])
ggcorrplot(matcor1, hc.order = TRUE, type = "lower", lab = "TRUE")
```


#Análisis descriptivo

```{r}
#Resumen numérico
resumen <- summary(datosnew[,c(10,4,5,8,9)])
```

```{r}
#Diagrama de violín Y_F
ggplot(datosnew, aes(x = "", y = Y_F)) + 
  geom_violin(fill = "#2F4F4F", alpha = 0.7) +
  geom_jitter(width = 0.1, height = 0, size = 2, alpha = 0.7, color = "#1B4F1B") +
  labs(
    title = "",
    x = "",
    y = expression(Y[F])
  ) +  # <- este '+' iba antes de theme_minimal()
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```



```{r}
#Func diagrama de violín gestos

plot_violin <- function(data, variable_name, subindice = NULL) {
  # Calcular media y mediana
  stats_df <- data %>%
    summarise(
      Media = mean(.data[[variable_name]], na.rm = TRUE),
      Mediana = median(.data[[variable_name]], na.rm = TRUE)
    ) %>%
    tidyr::pivot_longer(cols = everything(), names_to = "estadístico", values_to = "valor")

  # Crear etiqueta dinámica con subíndice
  y_label <- if (!is.null(subindice)) {
    bquote(Y[.(subindice)])
  } else {
    variable_name
  }

  ggplot(data, aes_string(x = '""', y = variable_name)) +
    geom_violin(fill = "#2F4F4F", alpha = 0.7) +
    geom_jitter(width = 0.1, height = 0, size = 2, alpha = 0.7, color = "#1B4F1B") +
    geom_point(data = stats_df, aes(x = "", y = valor, color = estadístico, shape = estadístico), size = 4) +
    scale_color_manual(values = c(Media = "red", Mediana = "blue"), name = "Estadístico") +
    scale_shape_manual(values = c(Media = 23, Mediana = 24), name = "Estadístico") +
    labs(
      x = "",
      y = expression(Y[L])
    ) +
    coord_cartesian(ylim = c(0, 1)) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    )
}

# Graficar cada variable por separado
p_YC <- plot_violin(datosnew, "Y_C")
p_YP <- plot_violin(datosnew, "Y_P")
p_YS <- plot_violin(datosnew, "Y_S")
p_YL <- plot_violin(datosnew, "Y_L")

# Mostrar los gráficos (uno por uno)
print(p_YC)
print(p_YP)
print(p_YS)
print(p_YL)

```


```{r}
#Furia según sexo
ggplot(datosnew, aes(x = Sex, y = Y_F, fill = Sex)) +
  geom_violin(alpha = 0.7) +
  geom_jitter(width = 0.15, height = 0, size = 2, alpha = 0.7, color = "#1B4F1B") +
  scale_fill_manual(values = c("F" = "#2F4F4F", "M" = "#4E8A4F")) +
  labs(title = "",
       x = "Sexo",
       y = expression(Y[F])) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none"
  )
```

```{r}
#Furia según fase
ggplot(datosnew, aes(x = Phase, y = Y_F, fill = Phase)) +
  geom_violin(alpha = 0.7) +
  geom_jitter(width = 0.15, height = 0, size = 2, alpha = 0.7, color = "#1B4F1B") +
  scale_fill_manual(values = c("#2F4F4F", "#4E8A4F")) +  
  labs(title = "",
       x = "Fase",
       y = expression(Y[F])) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none"
  )
```


